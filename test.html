<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>

<script>
    function showConvertedModel(ctx) {
        let _get_buffer1 = Module.cwrap('get_buffer1', "number", ["number"])
        let _get_buffer2 = Module.cwrap('get_buffer2', "number", ["number"])
        let _get_buffer_size1 = Module.cwrap('get_buffer_size1', "number", ["number"])
        let _get_buffer_size2 = Module.cwrap('get_buffer_size2', "number", ["number"])
        bufferOffset1 = _get_buffer1(ctx);
        bufferSize1 = _get_buffer_size1(ctx);
        output1 = new Uint8Array(HEAP8.subarray(bufferOffset1, bufferOffset1 + bufferSize1));
        let url1 = createObjectURL(output1)
        console.log(url1);
        bufferOffset2 = _get_buffer2(ctx);
        bufferSize2 = _get_buffer_size2(ctx);
        output2 = new Uint8Array(HEAP8.subarray(bufferOffset2, bufferOffset2 + bufferSize2));
        let url2 = createObjectURL(output2)
        console.log(url2);
        document.getElementById('result1').innerHTML = '<a href="' + url1 + '" download="' + 'ncnn_param">ncnn_param</a>'
        document.getElementById('result2').innerHTML = '<a href="' + url2 + '" download="' + 'ncnn_bin">ncnn_bin</a>'
    }

    function transferToHeap(ui8a) {
        heapSpace = Module._malloc(ui8a.length *
            ui8a.BYTES_PER_ELEMENT); // 1
        Module.HEAP8.set(ui8a, heapSpace); // 2 
        return heapSpace;
    }

    const readFileAsArrayBuffer = (inputFile) => {
        const temporaryFileReader = new FileReader();

        return new Promise((resolve, reject) => {
            temporaryFileReader.onerror = () => {
                temporaryFileReader.abort();
                reject(new DOMException("Problem parsing input file."));
            };

            temporaryFileReader.onload = () => {
                resolve(temporaryFileReader.result);
            };
            temporaryFileReader.readAsArrayBuffer(inputFile);
        });
    };

    const onnx2ncnn_js = async (files) => {
        var ctx = Module.ccall('create_exporter', 'number');

        const arr = await readFileAsArrayBuffer(files[0]);

        let ui8a = new Uint8Array(arr);
        let convert = Module.cwrap("onnx2ncnn_export", ["number", "array", "number"])
        let ui8a_heap = transferToHeap(ui8a)
        convert(ctx, ui8a_heap, ui8a.length);

        showConvertedModel(ctx);

        Module.ccall('free_exporter', null, ['number'], ctx);
    }

    const caffe2ncnn_js = async (files) => {
        var ctx = Module.ccall('create_exporter', 'number');

        const prototxt = await readFileAsArrayBuffer(files[0]);
        const caffemodel = await readFileAsArrayBuffer(files[1]);

        let prototxt_ui8a = new Uint8Array(prototxt);
        let caffemodel_ui8a = new Uint8Array(caffemodel);
        let convert = Module.cwrap("caffe2ncnn_export", ["number", "array", "number", "array", "number"])
        let prototxt_heap = transferToHeap(prototxt_ui8a)
        let caffemodel_heap = transferToHeap(caffemodel_ui8a)
        convert(ctx, prototxt_heap, prototxt_ui8a.length, caffemodel_heap, caffemodel_ui8a.length);

        showConvertedModel(ctx);

        Module.ccall('free_exporter', null, ['number'], ctx);
    }

    //
    // create object url
    //
    function createObjectURL(array, type) {
        var useTypedArray = (typeof Uint8Array !== 'undefined');
        var isSafari = (
            navigator.userAgent.indexOf('Safari') !== -1 &&
            navigator.vendor.indexOf('Apple') !== -1
        );
        var data = '';
        var bb;
        var blob;
        var tmp;
        var i;
        var il;

        if (useTypedArray) {
            array = new Uint8Array(array);
        }

        // avoid blob url in safari
        if (!isSafari) {

            // Blob constructor
            try {
                blob = new Blob([array], {type: type});
            } catch (e) {
            }

            // BlobBuilder
            if (
                (tmp = window.WebkitBlobBuilder) !== void 0 ||
                (tmp = window.MozBlobBuilder) !== void 0 ||
                (tmp = window.MSBlobBuilder) !== void 0
            ) {
                bb = new tmp();
                bb.append(array.buffer);
                blob = bb.getBlob(type);
            }

            // createObjectURL
            if (blob && (
                ((tmp = window.URL) && tmp.createObjectURL) ||
                ((tmp = window.webkitURL) && tmp.createObjectURL)
            )) {
                return tmp.createObjectURL(blob);
            }
        }

        // DataURL
        for (i = 0, il = array.length; i < il;) {
            data += String.fromCharCode.apply(
                null,
                useTypedArray ?
                    array.subarray(i, i += 0x7fff) :
                    array.slice(i, i += 0x7fff)
            );
        }

        return 'data:' + type + ';base64,' + window.btoa(data);
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="cpp/build/export.js"></script>
<!-- 引入组件库 -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>

<div id='app'>
    <el-radio-group id='radio' v-model="inputFormat" :change='onSelectInputFormat'>
        <el-radio-button label="onnx"></el-radio-button>
        <el-radio-button label="caffe"></el-radio-button>
    </el-radio-group>
    <el-upload id='upload' class="upload-demo" action="https://jsonplaceholder.typicode.com/posts/" ref="upload"
        :on-preview="handlePreview" :on-remove="handleRemove" :before-remove="beforeRemove" :on-change="beforeUpload"
        multiple :limit="dqxlimit" :on-exceed="handleExceed" :http-request="uploadRequest" :file-list="fileList"
        :auto-upload="false">
        <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
        <el-button style="margin-left: 10px;" size="small" type="success" :disabled="uploadDisabled"
            @click="submitUpload">上传到服务器</el-button>

        <div slot="tip" class="el-upload__tip"> {{ inputFormat }} </div>
    </el-upload>
</div>
<script>
    var vm = new Vue({
        el: '#app',
        data: {
            inputFormat: 'onnx',
            fileList: [],
            uploadDisabled: true
        },
        computed: {
            dqxlimit: function () {
                let limit_dict = {
                    'onnx': 1,
                    'caffe': 2
                };
                return limit_dict[this.inputFormat];
            }
        },
        watch: {
            inputFormat: function (newValue, oldValue) {
                console.log(newValue);
                this.fileList = [];
                this.uploadDisabled = this.fileList.length != this.dqxlimit
            }
        },
        methods: {
            submitUpload() {
                const files = this.$refs.upload.uploadFiles.map(file => file.raw);
                let func_dict = {
                    'onnx': onnx2ncnn_js,
                    'caffe': caffe2ncnn_js
                };
                func_dict[this.inputFormat](files);
            },
            onSelectInputFormat(label) {
                console.log(label);
            },
            uploadRequest(option) {
                let file = option.file;
                console.log(file);
                console.log(file.size);
                console.log(file.type);
                onnx2ncnn_js(file);
            },
            beforeUpload(file, fileList) {
                this.uploadDisabled = fileList.length != this.dqxlimit
            },
            handleRemove(file, fileList) {
                this.uploadDisabled = fileList.length != this.dqxlimit
            },
            handlePreview(file) {
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 ${this.dqxlimit} 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                return this.$confirm(`确定移除 ${file.name}？`);
            }
        }
    })
</script>


<div id='result1'></div>
<div id='result2'></div>

</html>
