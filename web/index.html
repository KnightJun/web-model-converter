<!DOCTYPE html>
<html lang="en">

    <!-- asdfadsfasdf -->
<head>
    <meta charset="UTF-8">
    <title>一键转换 Caffe, ONNX, TensorFlow 到 NCNN, MNN, Tengine</title>
    <meta name="Description" content="网页一键将 Caffe ONNX TensorFlow 转为 NCNN, MNN, Tengine">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.11.1/lib/theme-chalk/index.css">
</head>
<div style="display:none">
    <script type="text/javascript" src="https://s5.cnzz.com/z_stat.php?id=1277797637&web_id=1277797637"></script>
</div>
<style>
    .content {
        max-width: 500px;
        margin: auto;
    }
    .el-footer {
        /* background-color: #B3C0D1; */
        color: #333;
        text-align: right;
        line-height: 60px;
        font-size: 15px;
    }
</style>


<script>
    function baseName(str)
    {
           var base = new String(str).substring(str.lastIndexOf('/') + 1); 
        if(base.lastIndexOf(".") != -1)       
            base = base.substring(0, base.lastIndexOf("."));
       return base;
    }

    function getConvertedMnnModelUrls(ctx) {
        let _get_buffer1 = Module.cwrap('get_buffer1', "number", ["number"])
        let _get_buffer_size1 = Module.cwrap('get_buffer_size1', "number", ["number"])
        bufferOffset1 = _get_buffer1(ctx);
        bufferSize1 = _get_buffer_size1(ctx);
        output1 = new Uint8Array(HEAP8.subarray(bufferOffset1, bufferOffset1 + bufferSize1));
        let url1 = createObjectURL(output1)
        return [url1];
    }

    function getConvertedModelsAndErrorMsg(ctx) {
        let _get_buffer1 = Module.cwrap('get_buffer1', "number", ["number"])
        let _get_buffer2 = Module.cwrap('get_buffer2', "number", ["number"])
        let _get_buffer3 = Module.cwrap('get_buffer3', "number", ["number"])
        let _get_buffer_size1 = Module.cwrap('get_buffer_size1', "number", ["number"])
        let _get_buffer_size2 = Module.cwrap('get_buffer_size2', "number", ["number"])
        let _get_buffer_size3 = Module.cwrap('get_buffer_size3', "number", ["number"])
        bufferOffset1 = _get_buffer1(ctx);
        bufferSize1 = _get_buffer_size1(ctx);
        console.log("size1 " + bufferSize1);
        output1 = new Uint8Array(HEAP8.subarray(bufferOffset1, bufferOffset1 + bufferSize1));
        bufferOffset2 = _get_buffer2(ctx);
        bufferSize2 = _get_buffer_size2(ctx);
        console.log("size2 " + bufferSize2);
        output2 = new Uint8Array(HEAP8.subarray(bufferOffset2, bufferOffset2 + bufferSize2));

        bufferOffset3 = _get_buffer3(ctx);
        bufferSize3 = _get_buffer_size3(ctx);

        console.log(bufferSize3);
        output3 = new Uint8Array(HEAP8.subarray(bufferOffset3, bufferOffset3 + bufferSize3));
        output3 = String.fromCharCode.apply(null, output3);

        return [output1, output2, output3];
    }

    function getErrorMsg(ctx) {
        let _get_buffer = Module.cwrap('get_buffer3', "number", ["number"])
        let _get_buffer_size = Module.cwrap('get_buffer_size3', "number", ["number"])
        bufferOffset = _get_buffer(ctx);
        bufferSize = _get_buffer_size(ctx);
        output = new Uint8Array(HEAP8.subarray(bufferOffset, bufferOffset + bufferSize));
        const str = String.fromCharCode.apply(null, output);

        return str;
    }

    function transferToHeap(ui8a) {
        heapSpace = Module._malloc(ui8a.length *
            ui8a.BYTES_PER_ELEMENT); // 1
        Module.HEAP8.set(ui8a, heapSpace); // 2 
        return heapSpace;
    }

    const readFileAsArrayBuffer = (inputFile) => {
        const temporaryFileReader = new FileReader();

        return new Promise((resolve, reject) => {
            temporaryFileReader.onerror = () => {
                temporaryFileReader.abort();
                reject(new DOMException("Problem parsing input file."));
            };

            temporaryFileReader.onload = () => {
                resolve(temporaryFileReader.result);
            };
            temporaryFileReader.readAsArrayBuffer(inputFile);
        });
    };

    const cpp_js_wrapper_core = (export_name, uint8_arrs, extra_args, extra_types, free=false) => {
        var ctx = Module.ccall('create_exporter', 'number');
        var args = [ctx];
        var arg_types = ["number"];
        const n = uint8_arrs.length;
        for (var i = 0; i < n; i++) {
            const arr = uint8_arrs[i];
            const arr_heap = transferToHeap(arr);
            args.push(arr_heap, arr.length);
            arg_types.push("array", "number");
        }
        const n2 = extra_args.length;
        for (var i = 0; i < n2; i++) {
            args.push(extra_args[i]);
            arg_types.push(extra_types[i]);
        }
        const convert = Module.cwrap(export_name, arg_types);
        const success = convert.apply(null, args);
        if (success) {
            ret = getConvertedModelsAndErrorMsg(ctx);
        } else {
            ret = getErrorMsg(ctx);
        }
        return [success, ret, ctx];
    }

    const files_to_uint8_arrs = async (files) => {
        const n = files.length;

        var uint8_arrs = []
        for (var i = 0; i < n; i++) {
            const arr = await readFileAsArrayBuffer(files[i]);
            const arr_ui8a = new Uint8Array(arr);
            uint8_arrs.push(arr_ui8a);
        }
       return uint8_arrs;
   }

    const cpp_js_wrapper = async (export_name, files, extra_args, extra_types) => {

        const uint8_arrs = await files_to_uint8_arrs(files);

        const tmp = cpp_js_wrapper_core(export_name, uint8_arrs, extra_args, extra_types);
        [success, ret, ctx] = tmp;

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);

        return [success, ret];
    };

    const ncnnoptimize_js = async (files, fp16) => {
        const export_name = 'ncnnoptimize_export';
        return cpp_js_wrapper(export_name, files, [fp16], ['bool']);
    }

    const onnxoptimize_js = async (files) => {
        const export_name = 'onnxsimplify_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const onnx_shape_infer_js = async (files) => {
        const export_name = 'onnx_shape_infer_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const onnxopt_and_shape_js = async (files) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        const tmp = cpp_js_wrapper_core('onnxoptimize_export', uint8_arrs, [], []);
       [success, ret, ctx] = tmp;
       if (!success || !(ret[2] === "")) {
            Module.ccall('free_exporter', null, ['number'], ctx);
            return tmp;
       }
       
       [success, ret, ctx] = cpp_js_wrapper_core('onnx_shape_infer_export', [ret[0]], [], [])

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }


    const onnx2ncnn_js = async (files, onnxopt, ncnnopt, fp16) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        if (onnxopt) {
            tmp = cpp_js_wrapper_core('onnxoptimize_export', uint8_arrs, [], []);
           [success, ret, ctx] = tmp;
           if (!success || !(ret[2] === "")) {
                Module.ccall('free_exporter', null, ['number'], ctx);
                return tmp;
           }
            uint8_arrs = [ret[0]];
        }

        tmp = cpp_js_wrapper_core('onnx2ncnn_export', uint8_arrs, [], []);
       [success, ret, ctx] = tmp;
       if (!success || !(ret[2] === "")) {
            Module.ccall('free_exporter', null, ['number'], ctx);
            return tmp;
       }
       
       if (ncnnopt) {
       [success, ret, ctx] = cpp_js_wrapper_core('ncnnoptimize_export', [ret[0], ret[1]], [fp16], ['bool'])
       }

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }

    const caffe2ncnn_js = async (files, opt, fp16) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        const tmp = cpp_js_wrapper_core('caffe2ncnn_export', uint8_arrs, [], []);
       [success, ret, ctx] = tmp;
       if (!success || !(ret[2] === "")) {
            Module.ccall('free_exporter', null, ['number'], ctx);
            return tmp;
       }
       
       if (opt) {
           [success, ret, ctx] = cpp_js_wrapper_core('ncnnoptimize_export', [ret[0], ret[1]], [fp16], ['bool'])
       }

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }

    const mxnet2ncnn_js = async (files, opt, fp16) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        const tmp = cpp_js_wrapper_core('mxnet2ncnn_export', uint8_arrs, [], []);
       [success, ret, ctx] = tmp;
       if (!success || !(ret[2] === "")) {
            Module.ccall('free_exporter', null, ['number'], ctx);
            return tmp;
       }
       
       if (opt) {
           [success, ret, ctx] = cpp_js_wrapper_core('ncnnoptimize_export', [ret[0], ret[1]], [fp16], ['bool'])
       }

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }

    const caffe2mnn_js = async (files) => {
        const export_name = 'caffe2mnn_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const onnx2mnn_js = async (files, opt) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        if (opt) {
            const tmp = cpp_js_wrapper_core('onnxoptimize_export', uint8_arrs, [], []);
           [success, ret, ctx] = tmp;
           if (!success || !(ret[2] === "")) {
                Module.ccall('free_exporter', null, ['number'], ctx);
                return tmp;
           }
            uint8_arrs = [ret[0]];
        }

       [success, ret, ctx] = cpp_js_wrapper_core('onnx2mnn_export', uint8_arrs, [], [])

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }

    const tf2mnn_js = async (files) => {
        const export_name = 'tf2mnn_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const onnx2tengine_js = async (files, opt) => {
        var uint8_arrs = await files_to_uint8_arrs(files);

        if (opt) {
            const tmp = cpp_js_wrapper_core('onnxoptimize_export', uint8_arrs, [], []);
           [success, ret, ctx] = tmp;
           if (!success || !(ret[2] === "")) {
                Module.ccall('free_exporter', null, ['number'], ctx);
                return tmp;
           }
            uint8_arrs = [ret[0]];
        }

       [success, ret, ctx] = cpp_js_wrapper_core('onnx2tengine_export', uint8_arrs, [], [])

        if (success) {
            ret[0] = createObjectURL(ret[0]);
            ret[1] = createObjectURL(ret[1]);
        }
        Module.ccall('free_exporter', null, ['number'], ctx);
        return [success, ret];
    }

    const caffe2tengine_js = async (files) => {
        const export_name = 'caffe2tengine_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const tf2tengine_js = async (files) => {
        const export_name = 'tf2tengine_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const mxnet2tengine_js = async (files) => {
        const export_name = 'mxnet2tengine_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const darknet2tengine_js = async (files) => {
        const export_name = 'darknet2tengine_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    const tflite2tengine_js = async (files) => {
        const export_name = 'tflite2tengine_export';
        return cpp_js_wrapper(export_name, files, [], []);
    }

    //
    // create object url
    //
    function createObjectURL(array, type) {
        var useTypedArray = (typeof Uint8Array !== 'undefined');
        var isSafari = (
            navigator.userAgent.indexOf('Safari') !== -1 &&
            navigator.vendor.indexOf('Apple') !== -1
        );
        var data = '';
        var bb;
        var blob;
        var tmp;
        var i;
        var il;

        if (useTypedArray) {
            array = new Uint8Array(array);
        }

        // avoid blob url in safari
        if (!isSafari) {

            // Blob constructor
            try {
                blob = new Blob([array], {type: type});
            } catch (e) {
            }

            // BlobBuilder
            if (
                (tmp = window.WebkitBlobBuilder) !== void 0 ||
                (tmp = window.MozBlobBuilder) !== void 0 ||
                (tmp = window.MSBlobBuilder) !== void 0
            ) {
                bb = new tmp();
                bb.append(array.buffer);
                blob = bb.getBlob(type);
            }

            // createObjectURL
            if (blob && (
                ((tmp = window.URL) && tmp.createObjectURL) ||
                ((tmp = window.webkitURL) && tmp.createObjectURL)
            )) {
                return tmp.createObjectURL(blob);
            }
        }

        // DataURL
        for (i = 0, il = array.length; i < il;) {
            data += String.fromCharCode.apply(
                null,
                useTypedArray ?
                    array.subarray(i, i += 0x7fff) :
                    array.slice(i, i += 0x7fff)
            );
        }

        return 'data:' + type + ';base64,' + window.btoa(data);
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
<script src="export.js"></script>
<!-- 引入组件库 -->
<script src="https://unpkg.com/element-ui@2.11.1/lib/index.js"></script>

<div id='app' class='content'>
    <el-container>
        <el-main>
            <el-row type="flex" class="row-bg" justify="center">
                <el-col :span='18'>
                    <div>
                        <h2>
                            省去编译转换工具的时间<br/>开箱即用，一键转换
                                        <el-tooltip class="item" effect="light"
                                            content="转换是完全由浏览器本身在本地进行的，您的模型不会被上传"
                                            placement="top-end">
                                            <i class='el-icon-info'></i>
                                        </el-tooltip>
                        </h2>
                        <div id='choose_output_format'>
                            <font size="4">选择目标格式：</font><br />
                            <div style="margin-top: 6px">
                                <el-radio-group id='radio' v-model='outputFormat' style="line-height: 20px">
                                    <el-radio label="tengine" style="width:70px">
                                        <font size='3'>tengine</font>
                                    </el-radio>
                                    <el-radio label="ncnn" style="width:60px">
                                        <font size='3'>ncnn</font>
                                    </el-radio>
                                    <el-radio label="mnn">
                                        <font size='3'>mnn</font>
                                    </el-radio>
                                    <el-radio label="onnx">
                                        <font size='3'>onnx</font>
                                        <el-tooltip class="item" effect="light"
                                            content="使用 onnx optimizer 对 onnx 模型进行优化，或对 onnx 模型做 shape inference"
                                            placement="top">
                                            <i class='el-icon-info'></i>
                                        </el-tooltip>
                                    </el-radio>
                                </el-radio-group>
                            </div>
                        </div>
                        <div style="margin-top: 15px" id='choose_input_format'>
                            <font size="4">选择输入格式：</font><br />
                            <div style="margin-top: 6px">
                                <el-radio-group id='radio' v-model="inputFormat" :change='onSelectInputFormat' style="line-height: 20px">
                                    <el-radio label="onnx" style="width:70px">
                                        <font size='3'>onnx</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat != "onnx"' label="caffe" style="width:60px">
                                        <font size='3'>caffe</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat == "mnn" || outputFormat == "tengine"' label="tf">
                                        <font size='3'>tensorflow</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat == "ncnn" || outputFormat == "tengine"' label="mxnet" style="width:70px">
                                        <font size='3'>mxnet</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat == "tengine"' label="darknet" style="width:60px">
                                        <font size='3'>darknet</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat == "tengine"' label="tflite">
                                        <font size='3'>tflite</font>
                                    </el-radio>
                                    <el-radio v-if='outputFormat == "ncnn" && outputFormat != "onnx"' label="ncnn">
                                        <font size='3'>ncnn</font>
                                            <el-tooltip class="item" effect="light"
                                                content="使用 ncnnoptimize 产生优化后的 ncnn 模型，可以提升速度"
                                                placement="top-end">
                                                <i class='el-icon-info'></i>
                                            </el-tooltip>
                                    </el-radio>
                                </el-radio-group>
                            </div>
                        </div>
                        <div style="margin-top: 15px" id='checkboxes'>
                            <el-checkbox v-if='inputFormat == "onnx"' v-model="onnxOpt">使用 onnx optimizer 优化模型</el-checkbox>
                            <el-checkbox v-if='outputFormat == "onnx"' v-model="onnxInferShape">产生有 shape 信息的模型</el-checkbox>
                            <el-checkbox v-if='outputFormat == "ncnn" && inputFormat != "ncnn"' v-model="ncnnConvertWithOpt">使用 ncnnoptimize 优化模型</el-checkbox>
                            <el-checkbox v-if='outputFormat == "ncnn" && (inputFormat == "ncnn" || ncnnConvertWithOpt)' v-model="ncnnoptFp16">产生 fp16 模型</el-checkbox>
                        </div>
                        <div style="margin-top: 20px; margin-right: 70px">
                            <el-upload id='select' action="blahblah" ref="select"
                                :on-remove="handleRemove" :on-change="beforeUpload" multiple :limit="dqxlimit"
                                :file-list="fileList" :auto-upload="false">
                                <div slot="tip" class="el-upload__tip">
                                    <font size="2">
                                        {{ uploadTip }}
                                    </font>
                                </div>
                                <el-button slot="trigger" type="primary" :disabled='selectDisabled'>选择</el-button>
                                <el-button style="margin-left: 30px;" type="success" :disabled='convertDisabled || (outputFormat == "onnx" && !onnxOpt && !onnxInferShape)'
                                    @click="submitUpload">转换</el-button>
                            </el-upload>
                        </div>
                        <div style="margin-top: 15px">
                            <div v-if="showWaiting">
                                <font color='#909399'>
                                    <i class='el-icon-info'></i>
                                    转换中……
                                </font>
                            </div>
                            <div v-if='showSuccessMsg'>
                                <font color='#67C23A'>
                                    <i class='el-icon-success'></i>
                                    转换成功！
                                </font>
                                <br />
                            </div>
                            <div v-if='showUrls'>
                                <div style="margin-top: 5px">
                                    <el-link type='success' :download='paramFilename' :href='paramUrl'>{{ paramFilename }}</el-link>
                                    <br />
                                    <el-link type='success' :download='binFilename' :href='binUrl' v-if='outputFormat == "ncnn"'>{{ binFilename }}</el-link>
                                </div>
                            </div>
                            <div v-if='showErrorMsg'>
                                <font color='#F56C6C'>
                                    <i class='el-icon-error'></i>
                                    <p v-html="errorMsg"></p>
                                </font>
                            </div>
                        </div>
                    </div>
                </el-col>
            </el-row>
        </el-main>
    </el-container>
    <el-footer>
        Created by <a target="_blank" href="https://github.com/daquexian">daquexian</a>
                                        <el-tooltip class="item" effect="light"
                                            content="网页本身是我做的，模型转换部分仍基本使用了原各个框架转换工具的代码，感谢这些框架的作者们~"
                                            placement="top-end">
                                            <i class='el-icon-info'></i>
                                        </el-tooltip>
    </el-footer>
</div>
<script>
    var vm = new Vue({
        el: '#app',
        data: {
            inputFormat: 'onnx',
            outputFormat: 'tengine',
            fileList: [],
            selectDisabled: false,
            convertDisabled: true,
            hasResult: false,
            // Note: In ncnn, there are also converted models 
            // (which can be manually edited) even if the conversion fails.
            // so "convertSuccess" and "hasConvertedModel" are separated.
            convertSuccess: false,
            hasConvertedModel: false,
            ncnnoptFp16: false,
            ncnnConvertWithOpt: true,
            onnxOpt: true,
            onnxInferShape: true,
            latestFilename: 'model',
            showWaiting: false,
        },
        computed: {
            dqxlimit: function () {
                let limit_dict = {
                    'onnx': 1,
                    'caffe': 2,
                    'tf': 1,
                    'ncnn': 2,
                    'mxnet': 2,
                    'darknet': 2,
                    'tflite': 1,
                };
                return limit_dict[this.inputFormat];
            },
            uploadTip: function () {
                const msg_dict = {
                    'onnx': 'onnx 模型',
                    'caffe': 'prototxt 和 caffemodel 文件（按顺序）',
                    'tf': '.pb 模型',
                    'ncnn': 'param 和 bin 文件（按顺序）',
                    'mxnet': 'json 和 param 文件（按顺序）',
                    'darknet': 'cfg 和 weight 文件（按顺序）',
                    'tflite': 'tflite 文件',
                };
                return '请选择 ' + msg_dict[this.inputFormat];
            },
            showUrls: function () {return this.hasResult && this.hasConvertedModel},
            showErrorMsg: function () {return this.hasResult && !this.convertSuccess},
            showSuccessMsg: function () {return this.hasResult && this.convertSuccess},
        },
        watch: {
            inputFormat: function (newValue, oldValue) {
                console.log(newValue);
                console.log(this.fileList);
                this.fileList = [];
                this.convertDisabled = this.fileList.length != this.dqxlimit;
                this.selectDisabled = this.fileList.length == this.dqxlimit;
                this.hasResult = false;
            },
            outputFormat: function (newValue, oldValue) {
                this.fileList = [];
                this.hasResult = false;
                this.convertDisabled = this.fileList.length != this.dqxlimit;
                this.selectDisabled = this.fileList.length == this.dqxlimit;
                if ((this.inputFormat == "tf" && (newValue == "tengine" || newValue == "ncnn" || newValue == "onnx")) ||
                (this.inputFormat == "mxnet" && (newValue != "ncnn" && newValue != "tengine")) ||
                (this.inputFormat == "ncnn" && newValue != "ncnn") ||
                (this.inputFormat == "darknet" && newValue != "tengine") ||
                (this.inputFormat == "tflite" && newValue != "tengine")
                ) {
                    this.inputFormat = "onnx";
                }
            },
        },
        methods: {
            submitUpload() {
                this.hasResult = false;
                this.convertDisabled = true;
                this.showWaiting = true;
                const files = this.$refs.select.uploadFiles.map(file => file.raw);
                const onnx_func_dict = {
                    'onnx': (files) => {
                        if (this.onnxOpt && this.onnxInferShape) {
                            return onnxopt_and_shape_js(files);
                        }
                        if (this.onnxOpt) {
                            return onnxoptimize_js(files);
                        }
                        if (this.onnxInferShape) {
                            return onnx_shape_infer_js(files);
                        }
                    },
                };
                const ncnn_func_dict = {
                    'onnx': (files) => { return onnx2ncnn_js(files, this.onnxOpt, this.ncnnConvertWithOpt, this.ncnnoptFp16) },
                    'caffe': (files) => { return caffe2ncnn_js(files, this.ncnnConvertWithOpt, this.ncnnoptFp16); },
                    'mxnet': (files) => { return mxnet2ncnn_js(files, this.ncnnConvertWithOpt, this.ncnnoptFp16); },
                    'ncnn': (files) => { return ncnnoptimize_js(files, this.ncnnoptFp16) },
                    // 'caffe': caffe2mnn_js
                };
                const mnn_func_dict = {
                    'onnx': (files) => { return onnx2mnn_js(files, this.onnxOpt); },
                    'caffe': caffe2mnn_js,
                    'tf': tf2mnn_js,
                };
                const tengine_func_dict = {
                    'onnx': (files) => { return onnx2tengine_js(files, this.onnxOpt); },
                    'caffe': caffe2tengine_js,
                    'tf': tf2tengine_js,
                    'mxnet': mxnet2tengine_js,
                    'darknet': darknet2tengine_js,
                    'tflite': tflite2tengine_js,
                }
                const func_dict = {
                    'ncnn': ncnn_func_dict,
                    'mnn': mnn_func_dict,
                    'tengine': tengine_func_dict,
                    'onnx': onnx_func_dict,
                }
                try {
                const func = func_dict[this.outputFormat][this.inputFormat];
                func(files).then((ret) => {
                    this.hasResult = true;
                    const hasModel = ret[0];
                    this.hasConvertedModel = hasModel;
                    this.convertSuccess = hasModel;
                    this.convertDisabled = false;
                    this.showWaiting = false;
                    if (hasModel) {
                        if (this.outputFormat == 'ncnn') {
                            [this.paramUrl, this.binUrl, errorMsg] = ret[1];
                            console.log("js err: " + errorMsg);
                            this.paramFilename = 'ncnn_model.param';
                            this.binFilename = 'ncnn_model.bin';
                            this.paramFilename = latestFilename + (this.ncnnConvertWithOpt ? '-opt' : '') + (this.ncnnoptFp16 ? "-fp16" : "") + '.param'
                            this.binFilename = latestFilename + (this.ncnnConvertWithOpt ? '-opt' : '') + (this.ncnnoptFp16 ? "-fp16" : "") + '.bin'
                            console.log(this.binFilename);
                            if (!(errorMsg === "")) {
                                this.errorMsg = "转换遇到了一些错误，不过某些情况下你可以下载模型并 <a href=\"https://zhuanlan.zhihu.com/p/93017149\">手工修复</a> <br/>" + errorMsg;
                                this.convertSuccess = false;
                            }
                        } else if (this.outputFormat == 'mnn') {
                            [this.paramUrl] = ret[1];
                            this.paramFilename = latestFilename + '.mnn'
                        } else if (this.outputFormat == 'tengine') {
                            [this.paramUrl] = ret[1];
                            this.paramFilename = latestFilename + '.tmfile'
                        } else if (this.outputFormat == 'onnx') {
                            [this.paramUrl] = ret[1];
                            this.paramFilename = latestFilename + (this.onnxOpt ? '-opt' : '') + (this.onnxInferShape ? "-shape" : "") + '.onnx'
                        } 
                    } else {
                        this.errorMsg = ret[1];
                        console.log(this.errorMsg);
                    }
                }).catch(err => {
                    this.hasResult = true;
                    const hasModel = false;
                    this.hasConvertedModel = hasModel;
                    this.convertSuccess = hasModel;
                    this.convertDisabled = false;
                    this.showWaiting = false;
                    this.errorMsg = "遇到了未知错误：“" + err + "”，可以尝试向 " + this.outputFormat + " 开发者反馈";
                })
                } catch (err) {
                    this.hasResult = true;
                    const hasModel = false;
                    this.hasConvertedModel = hasModel;
                    this.convertSuccess = hasModel;
                    this.convertDisabled = false;
                    this.showWaiting = false;
                    this.errorMsg = "遇到了未知错误：" + err + "，请联系 daquexian";
                }
            },
            onSelectInputFormat(label) {
                console.log(label);
            },
            beforeUpload(file, fileList) {
                this.selectDisabled = fileList.length == this.dqxlimit;
                this.convertDisabled = fileList.length != this.dqxlimit;
                console.log(file.name);
                latestFilename = baseName(file.name);
            },
            handleRemove(file, fileList) {
                this.selectDisabled = fileList.length == this.dqxlimit;
                this.convertDisabled = fileList.length != this.dqxlimit;
                this.hasResult = false;
            },
        }
    })
</script>


</html>
